<!DOCTYPE html>
<html lang="en">
  <head>
    <title>E3db  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="E3db  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">E3db Docs</a> (100% documented)</p>
        <p class="header-right"><a href="https://github.com/tozny/e3db-swift"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">E3db Reference</a>
        <img id="carat" src="img/carat.png" />
        E3db  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Client.html">Client</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/ConfigAccessControl.html">ConfigAccessControl</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ConfigAccessControl/SecureEnclave.html">– SecureEnclave</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ConfigAccessControl/Keychain.html">– Keychain</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/E3dbError.html">E3dbError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/Signable.html">Signable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/AuthorizerPolicy.html">AuthorizerPolicy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ClientCredentials.html">ClientCredentials</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs.html#/s:4E3db9ClientKeyV">ClientKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ClientMeta.html">ClientMeta</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Config.html">Config</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DecryptedDocument.html">DecryptedDocument</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EAKInfo.html">EAKInfo</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EncryptedDocument.html">EncryptedDocument</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FileMeta.html">FileMeta</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IncomingSharingPolicy.html">IncomingSharingPolicy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/KeyPair.html">KeyPair</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Meta.html">Meta</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/OutgoingSharingPolicy.html">OutgoingSharingPolicy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/QueryParams.html">QueryParams</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/QueryResponse.html">QueryResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Record.html">Record</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RecordData.html">RecordData</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SignedDocument.html">SignedDocument</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs.html#/s:4E3db10SigningKeyV">SigningKey</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4E3db10CipherDataa">CipherData</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4E3db9Cleartexta">Cleartext</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4E3db0A10Completiona">E3dbCompletion</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4E3db0A6Resulta">E3dbResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4E3db9PlainMetaa">PlainMeta</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='e3db-swift' class='heading'>e3db-swift</h1>

<p>Client SDK in Swift for Tozny&rsquo;s E3DB.</p>

<p>The Tozny End-to-End Encrypted Database (E3DB) is a storage platform with
powerful sharing and consent management features. <a href="https://tozny.com/blog/announcing-project-e3db-the-end-to-end-encrypted-database/">Read more on our blog</a>.</p>

<p>E3DB provides a familiar JSON-based NoSQL-style API for reading, writing, and
querying data stored securely in the cloud.</p>
<h2 id='example' class='heading'>Example</h2>

<p>Get started by registering for a free account at <a href="https://console.tozny.com">Tozny&rsquo;s Console</a>.
Then create a <strong>Client Registration Token</strong> from the console and copy the token
value.</p>

<p>To run the example project, clone the repo, and run <code>pod install</code> from the
Example directory first.</p>

<p>Finally, paste the token value into the <code>ViewController.swift</code> source for the
line:</p>
<pre class="highlight swift"><code><span class="kd">private</span> <span class="k">let</span> <span class="nv">e3dbToken</span> <span class="o">=</span> <span class="s">"&lt;PASTE_CLIENT_TOKEN_HERE&gt;"</span>
</code></pre>
<h2 id='requirements' class='heading'>Requirements</h2>

<ul>
<li>iOS 9.0+</li>
</ul>
<h2 id='installation' class='heading'>Installation</h2>

<p>E3db is available through <a href="http://cocoapods.org">CocoaPods</a>. To install it,
simply add the following line to your Podfile:</p>
<pre class="highlight ruby"><code><span class="n">pod</span> <span class="s2">"E3db"</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/tozny/e3db-swift'</span>
</code></pre>
<h2 id='documentation' class='heading'>Documentation</h2>

<p>Full API documentation can be found <a href="https://tozny.github.io/e3db-swift">here</a>.
Code examples for the most common operations can be found below.</p>
<h4 id='register-a-new-client' class='heading'>Register a New Client</h4>

<p>Use the client token generated from the Tozny Console to register a new client:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">E3db</span>

<span class="c1">// This is the main client performing E3db operations</span>
<span class="c1">// (for the remaining examples, we'll assume a non-optional client instance)</span>
<span class="k">var</span> <span class="nv">e3db</span><span class="p">:</span> <span class="kt">Client</span><span class="p">?</span>

<span class="kt">Client</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">token</span><span class="p">:</span> <span class="n">e3dbToken</span><span class="p">,</span> <span class="nv">clientName</span><span class="p">:</span> <span class="s">"ExampleApp"</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>

        <span class="c1">// The operation was successful, here's the configuration</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">config</span><span class="p">):</span>
            <span class="c1">// create main E3db client with config</span>
            <span class="k">self</span><span class="o">.</span><span class="n">e3db</span> <span class="o">=</span> <span class="nf">Client</span><span class="p">(</span><span class="nv">config</span><span class="p">:</span> <span class="n">config</span><span class="p">)</span>

        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting registration: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">."</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='write-a-record' class='heading'>Write a Record</h4>

<p>Create a dictionary of <code>String</code> key-value pairs to store a record in E3db. The
keys of the dictionary will remain unencrypted, but the values will be encrypted
before ever leaving the device.</p>
<pre class="highlight swift"><code><span class="c1">// Wrap message in RecordData type to designate</span>
<span class="c1">// it as sensitive information for encryption</span>
<span class="k">let</span> <span class="nv">recordData</span> <span class="o">=</span> <span class="nf">RecordData</span><span class="p">(</span><span class="nv">cleartext</span><span class="p">:</span> <span class="p">[</span><span class="s">"SSN"</span><span class="p">:</span> <span class="s">"123-45-6789"</span><span class="p">])</span>

<span class="c1">// Can optionally include arbitrary metadata as `plain`</span>
<span class="c1">// where neither keys nor values are encrypted</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="s">"UserInfo"</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="n">recordData</span><span class="p">,</span> <span class="nv">plain</span><span class="p">:</span> <span class="p">[</span><span class="s">"Sent from"</span><span class="p">:</span> <span class="s">"my iPhone"</span><span class="p">])</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>

        <span class="c1">// The operation was successful, here's the record</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">record</span><span class="p">):</span>

            <span class="c1">// `record.meta` holds metadata associated</span>
            <span class="c1">// with the record, such as type.</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Wrote record! </span><span class="se">\(</span><span class="n">record</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">recordId</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to write the data: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='read-a-record' class='heading'>Read a Record</h4>

<p>You can request several records at once by specifying <code><a href="Structs/QueryParams.html">QueryParams</a></code>, but if you
already have the <code>recordId</code> of the record you want to read, you can request it
directly.</p>
<pre class="highlight swift"><code><span class="c1">// Perform read operation with the recordId of the</span>
<span class="c1">// written record, decrypting it after getting the</span>
<span class="c1">// encrypted data from the server.</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="nv">recordId</span><span class="p">:</span> <span class="n">recordId</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>

    <span class="c1">// The operation was successful, here's the record</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">record</span><span class="p">):</span>

        <span class="c1">// The record returned contains the same dictionary</span>
        <span class="c1">// supplied to the `RecordData` struct during the write</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Record data: </span><span class="se">\(</span><span class="n">record</span><span class="o">.</span><span class="n">data</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to read the record: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='query-for-records' class='heading'>Query for Records</h4>

<p>To request several records, and even filter on a set of optional parameters,
pass a <code><a href="Structs/QueryParams.html">QueryParams</a></code> instance to the <code>query</code> method.</p>
<pre class="highlight swift"><code><span class="c1">// Keep track of queried batches</span>
<span class="k">var</span> <span class="nv">lastRead</span><span class="p">:</span> <span class="kt">Double</span><span class="p">?</span>

<span class="c1">// Construct query, filtering to:</span>
<span class="c1">// - return only 5 records at a time,</span>
<span class="c1">// - only "UserInfo" type records,</span>
<span class="c1">// - including records written by others</span>
<span class="c1">//   that have been shared with this client</span>
<span class="k">let</span> <span class="nv">q1</span> <span class="o">=</span> <span class="nf">QueryParams</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nv">types</span><span class="p">:</span> <span class="p">[</span><span class="s">"UserInfo"</span><span class="p">],</span> <span class="nv">includeAllWriters</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">query</span><span class="p">(</span><span class="nv">params</span><span class="p">:</span> <span class="n">q1</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>

    <span class="c1">// The operation was successful, here's the `QueryResponse`,</span>
    <span class="c1">// which has the resulting records and an index for last record</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">resp</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Records: </span><span class="se">\(</span><span class="n">resp</span><span class="o">.</span><span class="n">records</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="n">lastRead</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">last</span>

    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to query records: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Query for next batch using `next`</span>
<span class="k">let</span> <span class="nv">q2</span> <span class="o">=</span> <span class="n">q1</span><span class="o">.</span><span class="nf">next</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">lastRead</span><span class="o">!</span><span class="p">)</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">query</span><span class="p">(</span><span class="nv">params</span><span class="p">:</span> <span class="n">q2</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre>

<p>Possible filters include:</p>

<ul>
<li><code>count</code>: Limit the number of records returned by the query beyond the default</li>
<li><code>includeData</code>: Supply the full decrypted record data in the result records</li>
<li><code>writerIds</code>: Filter to records written by these IDs</li>
<li><code>userIds</code>: Filter to records with these user IDs</li>
<li><code>recordIds</code>: Filter to only the records identified by these IDs</li>
<li><code>types</code>: Filter to records that match the given types</li>
<li><code>after</code>: Number to facilitate paging the results &ndash; used with the <code>last</code>
property of the resulting <code><a href="Structs/QueryResponse.html">QueryResponse</a></code></li>
<li><code>includeAllWriters</code>: Set this flag to include records that have been shared
with you, defaults to <code>false</code></li>
</ul>
<h4 id='sharing' class='heading'>Sharing</h4>

<p>Records can be shared to allow other clients access. Grant clients read access
by specifying which client and which type of record <code>share</code>. Inversely, access
can be removed with the <code>revoke</code> method.</p>
<pre class="highlight swift"><code><span class="c1">// Get the recipient client ID externally</span>
<span class="k">let</span> <span class="nv">otherClient</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="p">???</span>

<span class="c1">// Share records of type "UserInfo" with another client</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">share</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="s">"UserInfo"</span><span class="p">,</span> <span class="nv">readerId</span><span class="p">:</span> <span class="n">otherClient</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">result</span> <span class="nf">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to grant access to records: </span><span class="se">\(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Sharing was successful!</span>
<span class="p">}</span>

<span class="c1">// Remove access to "UserInfo" records from the given client</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">revoke</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="s">"UserInfo"</span><span class="p">,</span> <span class="nv">readerId</span><span class="p">:</span> <span class="n">otherClient</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">result</span> <span class="nf">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to revoke access to records: </span><span class="se">\(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Revoking was successful!</span>
<span class="p">}</span>
</code></pre>
<h4 id='authorizers' class='heading'>Authorizers</h4>

<p>Every E3DB client can authorize any other client to share data on their behalf.
That is, the data producer does not need to be the sole entity that enables
sharing with other clients. We call the client that is allowed to share data on
a data producer&rsquo;s behalf the <q>authorizer</q>.</p>

<p>Just like <code>share</code>, authorization is granted based on record types. That is, a
client can only authorize another client to share a specific record type. There
is no mechanism to grant sharing of all record types (whether any exist or not).</p>

<p>Note that the authorizer does <em>not</em> have permission to read the data shared
themselves - they are only allowed to share data on behalf of the data producer.</p>

<p>To add an authorizer, use the <code>add(authorizerId:type:completion:)</code> method:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">authorizerId</span> <span class="o">=</span> <span class="c1">// ID of client to share on this data producer's behalf</span>
<span class="k">let</span> <span class="nv">recordType</span>   <span class="o">=</span> <span class="c1">// type of records to authorize</span>

<span class="n">e3db</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">authorizerId</span><span class="p">:</span> <span class="n">authorizerId</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">recordType</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">result</span> <span class="nf">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to grant authorizer privilege: </span><span class="se">\(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// client successfully authorized</span>
<span class="p">}</span>
</code></pre>

<p>Authorization can be removed with the <code>remove(authorizerId:...</code> methods.
Authorization <em>can</em> be removed for all record types, or for a single record
type.</p>

<p>A client can list all clients that it has authorized to share on its behalf
using the <code>add(authorizerId:type:completion:)</code> method. Similarly, a client can
determine all the data producers that it can share on behalf of using the
<code>getAuthorizedBy</code> method.</p>
<h4 id='sharing-as-an-authorizer' class='heading'>Sharing as an Authorizer</h4>

<p>A client that has been given permission to share records on behalf of a writer
can use the <code>share(onBehalfOf:type:readerId:completion:)</code> method:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">writerId</span>   <span class="o">=</span> <span class="c1">// ID of data writer</span>
<span class="k">let</span> <span class="nv">readerId</span>   <span class="o">=</span> <span class="c1">// ID of client we are sharing with</span>
<span class="k">let</span> <span class="nv">recordType</span> <span class="o">=</span> <span class="c1">// type of records to share</span>

<span class="n">e3db</span><span class="o">.</span><span class="nf">share</span><span class="p">(</span><span class="nv">onBehalfOf</span><span class="p">:</span> <span class="n">writerId</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">recordType</span><span class="p">,</span> <span class="nv">readerId</span><span class="p">:</span> <span class="n">readerId</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">result</span> <span class="nf">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to share: </span><span class="se">\(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// successfully shared</span>
<span class="p">}</span>
</code></pre>
<h4 id='local-encryption-amp-decryption' class='heading'>Local Encryption &amp; Decryption</h4>

<p>The E3DB SDK allows you to encrypt documents for local storage, which can
be decrypted later, by the client that created the document or any client with
which the document has been <code>shared</code>. Note that locally encrypted documents
<em>cannot</em> be written directly to E3DB &ndash; they must be decrypted locally and
written using the <code>write</code> or <code>update</code> methods.</p>

<p>Local encryption (and decryption) requires two steps:</p>

<ol>
<li>Create a &lsquo;writer key&rsquo; (for encryption) or obtain a &lsquo;reader key&rsquo; (for
decryption).</li>
<li>Call <code>encrypt</code> to encrypt a new document. For decryption, call <code>decrypt</code>.</li>
</ol>

<p>The &lsquo;writer key&rsquo; and &lsquo;reader key&rsquo; are both <code><a href="Structs/EAKInfo.html">EAKInfo</a></code> objects. An <code><a href="Structs/EAKInfo.html">EAKInfo</a></code>
object holds an encrypted key that can be used by the intended client to encrypt
or decrypt associated documents. A writer key can be created by calling
<code>createWriterKey</code>; a &lsquo;reader key&rsquo; can be obtained by calling <code>getReaderKey</code>.
(Note that the client calling <code>getReaderKey</code> will only receive a key if the
writer of those records has given access to the calling client through the
<code>share</code> operation.)</p>

<p>The <code>createWriterKey</code> and <code>getReaderKey</code> are networked operations, (which means
they are asynchronous operations as well), but can be performed once ahead of
time. The <code><a href="Structs/EAKInfo.html">EAKInfo</a></code> instances returned from those operations are safe to store
locally, and can be used in the non-networked operations of <code>encrypt</code> and
<code>decrypt</code>.</p>

<p>Here is an example of encrypting a document locally:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">recordData</span> <span class="o">=</span> <span class="nf">RecordData</span><span class="p">(</span><span class="nv">cleartext</span><span class="p">:</span> <span class="p">[</span><span class="s">"SSN"</span><span class="p">:</span> <span class="s">"123-45-6789"</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">recordType</span> <span class="o">=</span> <span class="s">"UserInfo"</span>

<span class="n">e3db</span><span class="o">.</span><span class="nf">createWriterKey</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>
    <span class="c1">// The operation was successful, here's the `EAKInfo` instance,</span>
    <span class="c1">// you can think of this as the "encryption key", but it's also encrypted,</span>
    <span class="c1">// so you don't have to worry about storing it in plaintext or exposing it.</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">eak</span><span class="p">):</span>
        <span class="c1">// attempt to create an encrypted document with the EAKInfo</span>
        <span class="k">let</span> <span class="nv">encrypted</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="n">e3db</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">recordType</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="n">recordData</span><span class="p">,</span> <span class="nv">eakInfo</span><span class="p">:</span> <span class="n">eak</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Encrypted document: </span><span class="se">\(</span><span class="n">encrypted</span><span class="o">!</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to create writer key: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>(Note that the <code><a href="Structs/EAKInfo.html">EAKInfo</a></code> instance is safe to store with the encrypted data, as
it is also encrypted). The client can decrypt the given record as follows:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">encrypted</span> <span class="o">=</span> <span class="c1">// get encrypted document (e.g. read from local storage)</span>
<span class="k">let</span> <span class="nv">writerKey</span> <span class="o">=</span> <span class="c1">// get stored EAKInfo instance (e.g. from local storage)</span>

<span class="c1">// attempt to decrypt an encrypted document with the EAKInfo instance</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="k">try</span> <span class="n">e3db</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">encryptedDoc</span><span class="p">:</span> <span class="n">encrypted</span><span class="p">,</span> <span class="nv">eakInfo</span><span class="p">:</span> <span class="n">writerKey</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Decrypted document: </span><span class="se">\(</span><span class="n">decrypted</span><span class="o">!</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>  
</code></pre>
<h5 id='local-decryption-of-shared-records' class='heading'>Local Decryption of Shared Records</h5>

<p>When two clients have a sharing relationship, the &lsquo;reader&rsquo; can locally decrypt
any documents encrypted by the &lsquo;writer,&rsquo; without using E3DB for storage.</p>

<ul>
<li>The &lsquo;writer&rsquo; must first share records with a &lsquo;reader&rsquo;, using the <code>share</code>
method.</li>
<li>The &lsquo;reader&rsquo; must then obtain a reader key using <code>getReaderKey</code>.</li>
</ul>

<p>Note that these are networked operations. However, the <code><a href="Structs/EAKInfo.html">EAKInfo</a></code> instance can be
saved for later use.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">encrypted</span>  <span class="o">=</span> <span class="c1">// get encrypted document (e.g. read from local storage)</span>
<span class="k">let</span> <span class="nv">writerID</span>   <span class="o">=</span> <span class="c1">// ID of writer that produced record</span>
<span class="k">let</span> <span class="nv">recordType</span> <span class="o">=</span> <span class="s">"UserInfo"</span>
<span class="k">var</span> <span class="nv">eakInfo</span><span class="p">:</span> <span class="kt">EAKInfo</span><span class="p">?</span>

<span class="n">e3db</span><span class="o">.</span><span class="nf">getReaderKey</span><span class="p">(</span><span class="nv">writerId</span><span class="p">:</span> <span class="n">writerID</span><span class="p">,</span> <span class="nv">userId</span><span class="p">:</span> <span class="n">writerID</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">recordType</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>
    <span class="c1">// The operation was successful, here's the `EAKInfo` instance,</span>
    <span class="c1">// you can think of this as the "encryption key", but it's also encrypted,</span>
    <span class="c1">// so you don't have to worry about storing it in plaintext or exposing it.</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">eak</span><span class="p">):</span>
      <span class="k">self</span><span class="o">.</span><span class="n">eakInfo</span> <span class="o">=</span> <span class="n">eak</span>

    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to get reader key: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The <code><a href="Structs/EAKInfo.html">EAKInfo</a></code> type conforms to Swift&rsquo;s <code>Codable</code> protocol for easy
serialization, e.g. for saving to <code>UserDefaults</code>:</p>
<pre class="highlight swift"><code><span class="c1">// store in UserDefaults</span>
<span class="c1">// assumes eakInfo is a non-optional `EAKInfo` instance</span>
<span class="k">let</span> <span class="nv">eakData</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">eakInfo</span><span class="p">)</span>
<span class="kt">UserDefaults</span><span class="o">.</span><span class="n">standard</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="n">eakData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"myReaderKey"</span><span class="p">)</span>
</code></pre>
<pre class="highlight swift"><code><span class="c1">// retrieve from UserDefaults</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">eakData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">UserDefaults</span><span class="o">.</span><span class="n">standard</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="s">"myReaderKey"</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Data</span><span class="p">)</span> <span class="nf">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"Could not retrieve eak data from defaults"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// deserialize into eakInfo</span>
<span class="k">let</span> <span class="nv">eakInfo</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">JSONDecoder</span><span class="p">()</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">EAKInfo</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">eakData</span><span class="p">)</span>
</code></pre>

<p>After obtaining a reader key, the &lsquo;reader&rsquo; can then decrypt any
records encrypted by the writer as follows:</p>
<pre class="highlight swift"><code><span class="c1">// attempt to decrypt an encrypted document with the EAKInfo instance</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="k">try</span> <span class="n">e3db</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">encryptedDoc</span><span class="p">:</span> <span class="n">encrypted</span><span class="p">,</span> <span class="nv">eakInfo</span><span class="p">:</span> <span class="n">eakInfo</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Decrypted document: </span><span class="se">\(</span><span class="n">decrypted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>  
</code></pre>
<h4 id='document-signing-amp-verification' class='heading'>Document Signing &amp; Verification</h4>

<p>Every E3DB client created with this SDK is capable of signing documents and
verifying the signature associated with a document. By attaching signatures to
documents, clients can be confident in:</p>

<ul>
<li>Document integrity - the document&rsquo;s contents have not been altered (because
the signature will not match).</li>
<li>Proof-of-authorship - The author of the document held the private signing
key associated with the given public key when the document was created.</li>
</ul>

<p>Signatures require the target type to conform to the <code><a href="Protocols/Signable.html">Signable</a></code> protocol. This
protocol requires one method to be implemented:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">serialized</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span>
</code></pre>

<p>This method must provide a reproducible string representation of the data to
sign and verify. This requires the serialization to be deterministic &ndash; i.e.
types such as <code>Dictionary</code> and <code>Set</code> must be serialized in a reproducible order.</p>

<p>The E3db types of <code><a href="Structs/EncryptedDocument.html">EncryptedDocument</a></code> and <code><a href="Structs/SignedDocument.html">SignedDocument</a></code> conform to the
<code><a href="Protocols/Signable.html">Signable</a></code> protocol.</p>

<p>To create a signature, use the <code>sign</code> method. (This example assumes an encrypted
document as create above):</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">encrypted</span> <span class="o">=</span> <span class="c1">// get encrypted document (or anything that conforms to `Signable`)</span>
<span class="k">let</span> <span class="nv">signedDoc</span> <span class="o">=</span> <span class="k">try</span> <span class="n">e3db</span><span class="o">.</span><span class="nf">sign</span><span class="p">(</span><span class="nv">document</span><span class="p">:</span> <span class="n">encrypted</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Signed Document: </span><span class="se">\(</span><span class="n">signedDoc</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
</code></pre>

<p>To verify a document, use the <code>verify</code> method. Here, we use the same <code>signedDoc</code>
instance as above. <code>config</code> holds the private &amp; public keys for the client.
(Note that, in general, <code>verify</code> requires the public signing key of the client
that wrote the record):</p>
<pre class="highlight swift"><code><span class="k">guard</span> <span class="k">try</span> <span class="n">e3db</span><span class="o">.</span><span class="nf">verify</span><span class="p">(</span><span class="nv">signed</span><span class="p">:</span> <span class="n">signed</span><span class="p">,</span> <span class="nv">pubSigKey</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">publicSigKey</span><span class="p">))</span> <span class="nf">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"Document failed verification"</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Document verified!</span>
</code></pre>
<h4 id='reading-and-writing-files' class='heading'>Reading and Writing Files</h4>

<p>E3DB supports the storage of large encrypted files, using a similar interface
for reading and writing records. The SDK will handle encrypting and uploading
the file. Similarly, it will download and decrypt files as well.</p>

<p>To write a file, use the <code>writeFile</code> method.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="nf">Data</span><span class="p">(</span><span class="s">"Hello there"</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">src</span>  <span class="o">=</span> <span class="kt">FileManager</span>
    <span class="o">.</span><span class="k">default</span>
    <span class="o">.</span><span class="n">temporaryDirectory</span>
    <span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="s">"source-file"</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">appendingPathExtension</span><span class="p">(</span><span class="s">"txt"</span><span class="p">)</span>

<span class="k">guard</span> <span class="kt">FileManager</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">createFile</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nv">contents</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span> <span class="nf">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"Could not create file"</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">recordId</span><span class="p">:</span> <span class="kt">UUID</span><span class="p">?</span>
<span class="n">e3db</span><span class="o">.</span><span class="nf">writeFile</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">fileUrl</span><span class="p">:</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>
    <span class="c1">// The operation was successful, here's the `Meta` instance.</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">meta</span><span class="p">):</span>
        <span class="n">recordId</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">recordId</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to write file: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Similarly, to read a file, use the <code>readFile</code> method. The <code>File</code> argument should
be the destination that the plaintext file will be written to. Continuing the
example above, you could read the file written as follows:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">dest</span> <span class="o">=</span> <span class="kt">FileManager</span>
    <span class="o">.</span><span class="k">default</span>
    <span class="o">.</span><span class="n">temporaryDirectory</span>
    <span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="s">"destination-file"</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">appendingPathExtension</span><span class="p">(</span><span class="s">"txt"</span><span class="p">)</span>

<span class="k">guard</span> <span class="kt">FileManager</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">createFile</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">dest</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nv">contents</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="nf">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="s">"Could not create file"</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">e3db</span><span class="o">.</span><span class="nf">readFile</span><span class="p">(</span><span class="nv">recordId</span><span class="p">:</span> <span class="n">recordId</span><span class="p">,</span> <span class="nv">destination</span><span class="p">:</span> <span class="n">dest</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="nf">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"File was downloaded, decrypted, and saved to </span><span class="se">\(</span><span class="n">dest</span><span class="o">.</span><span class="n">path</span><span class="se">)</span><span class="s">!"</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred attempting to read file: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h5 id='storage-requirements' class='heading'>Storage Requirements</h5>

<p>When uploading a file, the SDK expects to be able to (temporarily) store an
encrypted version of the plaintext file in the system&rsquo;s temporary directory.
Once the upload finishes (with or without error), the temporary file will be
deleted.</p>

<p>When downloading a file, you must provide a location to which the file can be
written. The SDK will save the encrypted file to storage, again in the system&rsquo;s
temporary directory. The SDK will then decrypt the encrypted file writing the
plaintext to the destination file.</p>

<p>In both cases, uploading and downloading, the SDK expects at least twice as much
free storage as the size of the plaintext or encrypted file.</p>
<h5 id='query-results' class='heading'>Query Results</h5>

<p>Query results may include file records (uploaded via the <code>writeFile</code> method).
A large file (vs. just a record) is indicated when the <code>fileMeta</code> property on
the <code><a href="Structs/Meta.html">Meta</a></code> instance is not <code>nil</code>. The contents of the file will <em>not</em> be
included in query results, even if the <code>includeData</code> parameter of the
<code><a href="Structs/QueryParams.html">QueryParams</a></code> is <code>true</code>. Use the <code>readFile</code> method to retrieve the contents of
the file.</p>

<p>Note that the <code>data</code> property will be empty when the record refers to a file.</p>
<h5 id='reading-records' class='heading'>Reading Records</h5>

<p>If the <code>read(recordId:)</code> method is used to read a record that refers to a file,
the result will be the same as when a query result contains a file record.
Namely, the record&rsquo;s <code>data</code> property will be empty, and the <code>fileMeta</code> property
of the returned <code>meta</code> will be non-<code>nil</code>.</p>
<h3 id='certificate-pinning' class='heading'>Certificate Pinning</h3>

<p>If desired, E3DB Clients can be provided with a <code>URLSession</code> instance. This can
allow custom configuration for networked calls, including pinning TLS sessions
to trusted certificate(s).</p>

<p>Simply supply a pre-configured <code>URLSession</code> to either the <code>Client.register</code> or
the <code>Client.init</code> methods.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">config</span>  <span class="o">=</span> <span class="c1">// load config from secure storage</span>

<span class="c1">// set custom delegate</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="nf">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">e3db</span>    <span class="o">=</span> <span class="nf">Client</span><span class="p">(</span><span class="nv">config</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span> <span class="nv">urlSession</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
</code></pre>

<p>The following shows an example of how to use the <code>URLSessionDelegate</code> callback
to restrict network activity to an intermediate certificate in a cert chain.</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">challenge</span><span class="p">:</span> <span class="kt">URLAuthenticationChallenge</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">AuthChallengeDisposition</span><span class="p">,</span> <span class="kt">URLCredential</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Adapted from OWASP https://www.owasp.org/index.php/Certificate_and_Public_Key_Pinning#iOS</span>
    <span class="k">let</span> <span class="nv">cancel</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="kt">AuthChallengeDisposition</span><span class="o">.</span><span class="n">cancelAuthenticationChallenge</span>

    <span class="k">guard</span> <span class="n">challenge</span><span class="o">.</span><span class="n">protectionSpace</span><span class="o">.</span><span class="n">authenticationMethod</span> <span class="o">==</span> <span class="kt">NSURLAuthenticationMethodServerTrust</span><span class="p">,</span>
          <span class="k">let</span> <span class="nv">trust</span> <span class="o">=</span> <span class="n">challenge</span><span class="o">.</span><span class="n">protectionSpace</span><span class="o">.</span><span class="n">serverTrust</span><span class="p">,</span>
          <span class="nf">SecTrustEvaluate</span><span class="p">(</span><span class="n">trust</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">==</span> <span class="n">errSecSuccess</span><span class="p">,</span>
          <span class="k">let</span> <span class="nv">serverCert</span> <span class="o">=</span> <span class="nf">SecTrustGetCertificateAtIndex</span><span class="p">(</span><span class="n">trust</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="nf">else</span> <span class="p">{</span> <span class="c1">// checks intermediate cert (index 1)</span>
            <span class="k">return</span> <span class="nf">completionHandler</span><span class="p">(</span><span class="n">cancel</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">pinnedCertData</span> <span class="o">=</span> <span class="nf">loadTrustedCertData</span><span class="p">()</span> <span class="c1">// load cert (e.g. from file)</span>
    <span class="k">let</span> <span class="nv">serverCertData</span> <span class="o">=</span> <span class="nf">SecCertificateCopyData</span><span class="p">(</span><span class="n">serverCert</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Data</span>

    <span class="k">guard</span> <span class="n">pinnedCertData</span> <span class="o">==</span> <span class="n">serverCertData</span> <span class="nf">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">completionHandler</span><span class="p">(</span><span class="n">cancel</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// pinning succeeded</span>
    <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">useCredential</span><span class="p">,</span> <span class="nf">URLCredential</span><span class="p">(</span><span class="nv">trust</span><span class="p">:</span> <span class="n">trust</span><span class="p">))</span>
<span class="p">}</span>
</code></pre>

          </section>
        </section>
        <section id="footer">
          <p>© 2018 <a class="link" href="https://tozny.com" target="_blank" rel="external">Tozny, LLC</a>.</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.1</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
