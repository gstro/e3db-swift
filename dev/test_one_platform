#!/bin/bash

# Script to run xcodebuild tests for a given iOS simulator platform.
# Platform list generated by `xcodebuild -scheme valid_scheme -destination "platform=unknown"`
# Results stored in 'testlogs' dir. Full results in test-<NAME>.log, formatted results in report-<NAME>.html
# Uses third party tools for convenience:
#   xcpretty - for formatting and reporting https://github.com/supermarin/xcpretty

if [ $# -lt 2 ]; then
  echo "Usage: $0 PLATFORM_STRING REPORT_NAME [Debug]" >&2
  exit 1
fi

mkdir -p testlogs

# pass in Debug to see debug output (may contain sensitive values)
CONFIG=${3:-Release}
WORKSPACE="../Example/E3db.xcworkspace"
SCHEME="E3db-Example"

xcodebuild \
  -workspace $WORKSPACE \
  -configuration $CONFIG \
  -scheme $SCHEME
  > /dev/null

xcodebuild test \
  -workspace $WORKSPACE \
  -configuration $CONFIG \
  -scheme $SCHEME \
  -destination "$1" |
    tee testlogs/test-$2.log |
      xcpretty --test \
      --report html \
      --output "testlogs/report-$2.html" \
      && exit ${PIPESTATUS[0]}
